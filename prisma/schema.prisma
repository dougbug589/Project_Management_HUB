model Discussion {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation("ProjectDiscussions", fields: [projectId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation("DiscussionAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([authorId])
}
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  avatar        String?
  bio           String?
  role          String  @default("TEAM_MEMBER")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  organizationsOwned Organization[]
  organizationMemberships OrganizationMember[]
  projectMemberships ProjectMember[]
  ownedProjects Project[]
  tasks         Task[]
  teamMemberships TeamMember[]
  comments      Comment[]
  activityLogs  ActivityLog[]
  assignedTasks TaskAssignee[]
  notifications Notification[]
  attachments   Attachment[]
  timesheets    Timesheet[]
  timesheetsApproved Timesheet[] @relation("TimesheetApprover")
  issuesAssigned Issue[] @relation("IssueAssignee")
  issuesReported Issue[] @relation("IssueReporter")
  documents     Document[]
  documentVersions DocumentVersion[]
  projectTemplates ProjectTemplate[] @relation("TemplateCreator")
  reportExports ReportExport[]
  orgInvitationsSent OrganizationMember[] @relation("OrgInviter")
  projectInvitationsSent ProjectMember[] @relation("ProjectInviter")
  discussions Discussion[] @relation("DiscussionAuthor")
  notificationPreference NotificationPreference?

  @@index([email])
}

// UserRole: SUPER_ADMIN | PROJECT_ADMIN | PROJECT_MANAGER | TEAM_MEMBER | CLIENT
// InvitationStatus: PENDING | ACCEPTED | DECLINED | REVOKED

model Organization {
  id          String   @id @default(cuid())
  name        String
  description String?
  billingEmail String?
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  memberships OrganizationMember[]
  projects    Project[]
  reportExports ReportExport[]

  @@index([ownerId])
}

model OrganizationMember {
  id        String    @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String  @default("TEAM_MEMBER")
  status    String @default("PENDING")
  invitedBy String?
  inviter   User?     @relation("OrgInviter", fields: [invitedBy], references: [id], onDelete: SetNull)
  joinedAt  DateTime  @default(now())

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model Project {
  id            String    @id @default(cuid())
  name          String
  description   String?
  ownerId       String
  owner         User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  organizationId String
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  templateId    String?
  template      ProjectTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  status        String @default("ACTIVE")
  startDate     DateTime?
  endDate       DateTime?
  archivedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tasks         Task[]
  teams         Team[]
  comments      Comment[]
  attachments   Attachment[]
  activityLogs  ActivityLog[]
  milestones    Milestone[]
  phases        Phase[]
  issues        Issue[]
  documents     Document[]
  members       ProjectMember[]
  reportExports ReportExport[]
    discussions Discussion[] @relation("ProjectDiscussions")

  @@index([ownerId])
  @@index([organizationId])
  @@index([status])
}


model Task {
  id            String    @id @default(cuid())
  title         String
  description   String?
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy     String
  creator       User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  
  status        String @default("TODO")
  priority      String @default("MEDIUM")
  dueDate       DateTime?
  startDate     DateTime?
  estimatedHours Float?
  actualHours   Float?
  
  milestoneId   String?
  milestone     Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  assignees     TaskAssignee[]
  comments      Comment[]
  attachments   Attachment[]
  activityLogs  ActivityLog[] @relation("taskActivity")
  subTasks      SubTask[]
  dependencies  TaskDependency[] @relation("parentTask")
  dependsOn     TaskDependency[] @relation("childTask")
  timesheets    Timesheet[]

  @@index([projectId])
  @@index([createdBy])
  @@index([status])
  @@index([priority])
  @@index([milestoneId])
}



model TaskAssignee {
  id        String    @id @default(cuid())
  taskId    String
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

model SubTask {
  id        String    @id @default(cuid())
  title     String
  description String?
  taskId    String
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  status    String @default("TODO")
  completed Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([taskId])
}

model TaskDependency {
  id        String    @id @default(cuid())
  parentTaskId String
  parentTask   Task      @relation("parentTask", fields: [parentTaskId], references: [id], onDelete: Cascade)
  childTaskId  String
  childTask    Task      @relation("childTask", fields: [childTaskId], references: [id], onDelete: Cascade)
  type      String @default("BLOCKED_BY")
  createdAt DateTime  @default(now())

  @@unique([parentTaskId, childTaskId])
  @@index([parentTaskId])
  @@index([childTaskId])
}


model ProjectTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  config      String?
  createdBy   String
  creator     User     @relation("TemplateCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projects    Project[]
}

model Team {
  id            String    @id @default(cuid())
  name          String
  description   String?
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  members       TeamMember[]

  @@index([projectId])
}

model ProjectMember {
  id        String    @id @default(cuid())
  projectId String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String  @default("TEAM_MEMBER")
  status    String @default("PENDING")
  invitedBy String?
  inviter   User?     @relation("ProjectInviter", fields: [invitedBy], references: [id], onDelete: SetNull)
  joinedAt  DateTime  @default(now())

  @@index([projectId])
  @@index([userId])
  @@unique([projectId, userId])
}

model TeamMember {
  id        String    @id @default(cuid())
  teamId    String
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String  @default("MEMBER")
  joinedAt  DateTime  @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}


model Comment {
  id        String    @id @default(cuid())
  content   String
  taskId    String?
  task      Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  projectId String?
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  authorId  String
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  replies   Comment[] @relation("commentReplies")
  parentId  String?
  parent    Comment?  @relation("commentReplies", fields: [parentId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([projectId])
  @@index([authorId])
}

model Attachment {
  id        String    @id @default(cuid())
  fileName  String
  fileSize  Int
  fileType  String
  fileUrl   String
  taskId    String?
  task      Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  projectId String?
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issueId   String?
  issue     Issue?    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  uploadedBy String?
  uploader  User?      @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)
  
  createdAt DateTime  @default(now())

  @@index([taskId])
  @@index([projectId])
  @@index([issueId])
}

model ActivityLog {
  id        String    @id @default(cuid())
  action    String
  entity    String
  entityId  String
  taskId    String?
  task      Task?     @relation("taskActivity", fields: [taskId], references: [id], onDelete: Cascade)
  projectId String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  changes   String?
  
  createdAt DateTime  @default(now())

  @@index([projectId])
  @@index([userId])
  @@index([entityId])
}


model Notification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String
  read      Boolean   @default(false)
  readAt    DateTime?
  actionUrl String?
  payload   String?
  
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([read])
}


model Milestone {
  id            String    @id @default(cuid())
  title         String
  description   String?
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dueDate       DateTime
  status        String @default("PENDING")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tasks         Task[]

  @@index([projectId])
  @@index([status])
}


model Phase {
  id          String    @id @default(cuid())
  name        String
  description String?
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  sequence    Int
  startDate   DateTime?
  endDate     DateTime?
  status      String @default("PENDING")
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([projectId])
  @@index([status])
}


model Issue {
  id            String    @id @default(cuid())
  title         String
  description   String?
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reportedBy    String?
  reporter      User?      @relation("IssueReporter", fields: [reportedBy], references: [id], onDelete: SetNull)
  assigneeId    String?
  assignee      User?     @relation("IssueAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  
  severity      String @default("MEDIUM")
  priority      String @default("MEDIUM")
  status        String @default("OPEN")
  dueDate       DateTime?
  
  // Relations
  attachments   Attachment[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId])
  @@index([reportedBy])
  @@index([assigneeId])
  @@index([severity])
  @@index([status])
}




model Timesheet {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskId        String
  task          Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  hoursLogged   Float
  date          DateTime
  description   String?
  status        String @default("PENDING")
  approvedBy    String?
  approver      User?     @relation("TimesheetApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([taskId])
  @@index([status])
}


model Document {
  id            String    @id @default(cuid())
  title         String
  description   String?
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy     String?
  creator       User?      @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  
  currentVersion Int      @default(1)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  versions      DocumentVersion[]

  @@index([projectId])
  @@index([createdBy])
}

model DocumentVersion {
  id            String    @id @default(cuid())
  documentId    String
  document      Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  versionNumber Int
  fileUrl       String
  fileName      String
  fileSize      Int
  fileType      String
  changeLog     String?
  
  createdBy     String?
  uploader      User?      @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  createdAt     DateTime  @default(now())

  @@unique([documentId, versionNumber])
  @@index([documentId])
}

model ReportExport {
  id             String        @id @default(cuid())
  projectId      String?
  project        Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  type           String
  format         String
  status         String @default("PENDING")
  fileUrl        String?
  errorMessage   String?
  createdBy      String
  creator        User         @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  completedAt    DateTime?

  @@index([projectId])
  @@index([organizationId])
  @@index([status])
}

model NotificationPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Email notifications
  emailTaskAssigned     Boolean  @default(true)
  emailTaskUpdated      Boolean  @default(true)
  emailCommentAdded     Boolean  @default(true)
  emailMilestoneAlert   Boolean  @default(true)
  emailDeadlineReminder Boolean  @default(true)
  emailIssueReported    Boolean  @default(true)
  emailTimesheetStatus  Boolean  @default(true)
  
  // In-app notifications
  inAppTaskAssigned     Boolean  @default(true)
  inAppTaskUpdated      Boolean  @default(true)
  inAppCommentAdded     Boolean  @default(true)
  inAppMilestoneAlert   Boolean  @default(true)
  inAppDeadlineReminder Boolean  @default(true)
  inAppIssueReported    Boolean  @default(true)
  inAppTimesheetStatus  Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}



